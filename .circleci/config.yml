aliases:
  # Workflow filters
  - &filter-only-release
    branches:
      ignore: /.*/
    tags:
      only: /^v[0-9]+(\.[0-9]+){2}(-.+|[^-.]*)$/
  - &filter-not-release
    tags:
      ignore: /^v[0-9]+(\.[0-9]+){2}(-.+|[^-.]*)$/

version: 2

jobs:
  mysql-integration-test:
    docker:
      - image: circleci/golang:1.10
      - image: circleci/mysql:5.6-ram
        environment:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: grafana_tests
          MYSQL_USER: grafana
          MYSQL_PASSWORD: password
    working_directory: /go/src/github.com/grafana/grafana
    steps:
        - checkout
        - run: sudo apt update
        - run: sudo apt install -y mysql-client
        - run: dockerize -wait tcp://127.0.0.1:3306 -timeout 120s
        - run: cat docker/blocks/mysql_tests/setup.sql | mysql -h 127.0.0.1 -P 3306 -u root -prootpass
        - run:
            name: mysql integration tests
            command: 'GRAFANA_TEST_DB=mysql go test ./pkg/...'
  postgres-integration-test:
    docker:
      - image: circleci/golang:1.10
      - image: circleci/postgres:9.3-ram
        environment:
          POSTGRES_USER: grafanatest
          POSTGRES_PASSWORD: grafanatest
    working_directory: /go/src/github.com/grafana/grafana
    steps:
        - checkout
        - run: sudo apt update
        - run: sudo apt install -y postgresql-client
        - run: dockerize -wait tcp://127.0.0.1:5432 -timeout 120s
        - run: cat docker/blocks/postgres_tests/setup.sql | PGPASSWORD=grafanatest psql -U grafanatest -p 5432 -h 127.0.0.1
        - run:
            name: postgres integration tests
            command: 'GRAFANA_TEST_DB=postgres go test ./pkg/...'


workflows:
  version: 2
  test:
    jobs:
      - mysql-integration-test
      - postgres-integration-test
